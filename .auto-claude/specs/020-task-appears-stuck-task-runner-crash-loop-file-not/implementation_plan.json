{
  "feature": "Fix Task Runner Crash Loop - File Not Found Error",
  "workflow_type": "investigation",
  "workflow_rationale": "This is an investigation workflow because the root cause (specific missing file) is unknown. Must first reproduce and identify the issue before implementing a fix. Investigation phase output will determine fix phase scope.",
  "phases": [
    {
      "id": "phase-1-reproduce",
      "name": "Reproduce & Locate Error",
      "type": "investigation",
      "description": "Reproduce the crash loop and identify the specific missing file through log analysis and code inspection",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Search for recent error logs and crash traces",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": ["INVESTIGATION.md"],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Document findings in INVESTIGATION.md: (1) Error logs found, (2) Stack traces captured, (3) Timestamps of crashes"
          },
          "status": "pending",
          "expected_output": "List of log files with file-not-found errors, including timestamps and context"
        },
        {
          "id": "subtask-1-2",
          "description": "Identify the exact file path causing the error",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Update INVESTIGATION.md with: (1) Exact file path, (2) Where it's being accessed, (3) Expected vs actual location"
          },
          "status": "pending",
          "expected_output": "Documented file path, code location accessing it, and why access is failing"
        },
        {
          "id": "subtask-1-3",
          "description": "Trace git history to check if file was moved or deleted",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "git log --diff-filter=D --summary --all -- [MISSING_FILE_PATH] | head -20",
            "expected": "Shows git history of file deletions/moves"
          },
          "status": "pending",
          "expected_output": "Git history showing if/when file was deleted or moved"
        }
      ]
    },
    {
      "id": "phase-2-root-cause",
      "name": "Analyze Root Cause",
      "type": "investigation",
      "description": "Determine why the file is missing and whether it should exist or code should handle absence gracefully",
      "depends_on": ["phase-1-reproduce"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Analyze task runner code to understand file dependency",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "apps/backend/spec/pipeline/agent_runner.py",
            "apps/backend/core/progress.py"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Update INVESTIGATION.md with: (1) Why file is accessed, (2) Is it required or optional, (3) Current error handling (if any)"
          },
          "status": "pending",
          "expected_output": "Root cause analysis: file purpose, whether it's required, and current handling"
        },
        {
          "id": "subtask-2-2",
          "description": "Determine crash loop mechanism and retry logic",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": ["apps/backend/services/orchestrator.py"],
          "verification": {
            "type": "manual",
            "instructions": "Document in INVESTIGATION.md: (1) How retry occurs, (2) Why it loops infinitely, (3) Where to add circuit breaker"
          },
          "status": "pending",
          "expected_output": "Understanding of retry mechanism and why it causes crash loop instead of failing gracefully"
        },
        {
          "id": "subtask-2-3",
          "description": "Formulate fix strategy based on findings",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Complete INVESTIGATION.md with: (1) Root cause summary, (2) Proposed fix, (3) Files to modify, (4) Testing plan"
          },
          "status": "pending",
          "expected_output": "Complete investigation report with actionable fix strategy"
        }
      ]
    },
    {
      "id": "phase-3-implement-fix",
      "name": "Implement Fix",
      "type": "implementation",
      "description": "Implement the fix based on investigation findings - add file validation and prevent crash loop",
      "depends_on": ["phase-2-root-cause"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Add file existence validation at startup/initialization",
          "service": "backend",
          "files_to_modify": ["TBD - determined by investigation"],
          "files_to_create": [],
          "patterns_from": [
            "apps/backend/spec/pipeline/agent_runner.py"
          ],
          "verification": {
            "type": "command",
            "command": "python -m pytest apps/backend/tests/test_file_validation.py -v",
            "expected": "File validation tests pass"
          },
          "status": "pending",
          "notes": "Use pattern from agent_runner.py:79-81: if not path.exists(): return False, f'File not found: {path}'"
        },
        {
          "id": "subtask-3-2",
          "description": "Implement crash loop prevention with max retries",
          "service": "backend",
          "files_to_modify": ["TBD - determined by investigation"],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Test that missing file causes graceful failure after max 3 retries, no infinite loop"
          },
          "status": "pending",
          "notes": "Add exponential backoff: base_delay=1.0s, max_delay=10.0s, max_retries=3"
        },
        {
          "id": "subtask-3-3",
          "description": "Improve error messages with file paths and suggestions",
          "service": "backend",
          "files_to_modify": ["TBD - determined by investigation"],
          "files_to_create": [],
          "patterns_from": [
            "apps/backend/spec/pipeline/agent_runner.py"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify error message includes: file path, current directory, suggested fix"
          },
          "status": "pending",
          "notes": "Error format: 'Required file not found: {path}\\nCurrent directory: {cwd}\\nPlease ensure file exists or check configuration'"
        }
      ]
    },
    {
      "id": "phase-4-test",
      "name": "Testing & Validation",
      "type": "implementation",
      "description": "Add comprehensive tests for file validation and crash loop prevention",
      "depends_on": ["phase-3-implement-fix"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Create unit tests for file validation",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": ["apps/backend/tests/test_file_validation.py"],
          "patterns_from": ["tests/test_merge_orchestrator.py"],
          "verification": {
            "type": "command",
            "command": "python -m pytest apps/backend/tests/test_file_validation.py -v",
            "expected": "All tests pass"
          },
          "status": "pending",
          "notes": "Test cases: missing required file, missing optional file, file permissions, path variations"
        },
        {
          "id": "subtask-4-2",
          "description": "Create integration test for crash loop prevention",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": ["apps/backend/tests/test_crash_loop_prevention.py"],
          "patterns_from": ["tests/test_service_orchestrator.py"],
          "verification": {
            "type": "command",
            "command": "python -m pytest apps/backend/tests/test_crash_loop_prevention.py -v",
            "expected": "Crash loop prevention tests pass"
          },
          "status": "pending",
          "notes": "Test: remove file, trigger task, verify max 3 retries, verify graceful failure"
        },
        {
          "id": "subtask-4-3",
          "description": "Verify existing tests still pass",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "python -m pytest apps/backend/tests/ -v --ignore=apps/backend/tests/test_file_validation.py --ignore=apps/backend/tests/test_crash_loop_prevention.py",
            "expected": "All existing tests pass"
          },
          "status": "pending",
          "notes": "Ensure changes don't break existing functionality"
        }
      ]
    },
    {
      "id": "phase-5-documentation",
      "name": "Documentation",
      "type": "cleanup",
      "description": "Document file dependencies and error handling improvements",
      "depends_on": ["phase-4-test"],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Document all file dependencies in README",
          "service": "backend",
          "files_to_modify": ["apps/backend/README.md"],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "README lists all required and optional files with their purposes"
          },
          "status": "pending",
          "notes": "Include file paths, when they're accessed, and what happens if missing"
        },
        {
          "id": "subtask-5-2",
          "description": "Update error handling documentation",
          "service": "backend",
          "files_to_modify": ["INVESTIGATION.md"],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "INVESTIGATION.md includes fix summary and lessons learned"
          },
          "status": "pending",
          "notes": "Document root cause, fix implemented, and how to prevent similar issues"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 5,
    "total_subtasks": 13,
    "services_involved": ["backend"],
    "parallelism": {
      "max_parallel_phases": 1,
      "parallel_groups": [],
      "recommended_workers": 1,
      "speedup_estimate": "Investigation workflow requires sequential execution",
      "reasoning": "Phase 2 depends on Phase 1 findings, Phase 3 depends on Phase 2 analysis. Cannot parallelize investigation workflow."
    },
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 020"
  },
  "verification_strategy": {
    "risk_level": "high",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": ["unit", "integration"],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "Missing file identified through investigation",
      "Crash loop no longer occurs",
      "Clear error messages display file paths and suggestions",
      "File validation added at startup",
      "All existing tests pass",
      "New tests cover file validation and crash loop scenarios"
    ],
    "verification_steps": [
      {
        "name": "Unit Tests",
        "command": "python -m pytest apps/backend/tests/test_file_validation.py -v",
        "expected_outcome": "All file validation tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Integration Tests",
        "command": "python -m pytest apps/backend/tests/test_crash_loop_prevention.py -v",
        "expected_outcome": "Crash loop prevention verified",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Regression Tests",
        "command": "python -m pytest apps/backend/tests/ -v",
        "expected_outcome": "All existing tests still pass",
        "type": "test",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "High-risk blocking issue requires thorough testing. Investigation must complete before fix can be implemented."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": ["python -m pytest apps/backend/tests/test_file_validation.py -v"],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": ["python -m pytest apps/backend/tests/test_crash_loop_prevention.py -v"],
      "services_to_test": ["backend"]
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": []
    },
    "browser_verification": {
      "required": false,
      "pages": []
    },
    "database_verification": {
      "required": false,
      "checks": []
    },
    "manual_checks": {
      "required": true,
      "checks": [
        {
          "name": "Verify crash loop eliminated",
          "description": "Remove suspected file, trigger task, verify graceful failure without infinite retry",
          "expected": "Task fails with clear error message after max 3 retries"
        },
        {
          "name": "Verify error message quality",
          "description": "Check error message includes file path, current directory, and suggested fix",
          "expected": "Error message is actionable and guides user to resolution"
        },
        {
          "name": "Verify investigation findings",
          "description": "Review INVESTIGATION.md for completeness",
          "expected": "Document includes root cause, evidence, proposed fix, and testing plan"
        }
      ]
    }
  },
  "qa_signoff": null
}
