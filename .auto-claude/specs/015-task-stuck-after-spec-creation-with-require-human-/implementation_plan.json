{
  "feature": "Spec Approval Mechanism for Human-in-the-Loop Workflow",
  "workflow_type": "feature",
  "workflow_rationale": "This is new functionality bridging a critical gap in the human-in-the-loop workflow. Adding approval UI and backend state transitions that don't currently exist, rather than fixing existing code or refactoring.",
  "phases": [
    {
      "id": "phase-1-backend-state",
      "name": "Backend Spec Approval State Management",
      "type": "implementation",
      "description": "Implement backend logic to transition tasks to plan_review state after spec creation and handle approval/rejection",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Add plan_review state transition after spec creation when requireReviewBeforeCoding is enabled",
          "service": "backend",
          "files_to_modify": ["apps/backend/spec/pipeline/orchestrator.py", "apps/backend/runners/spec_runner.py"],
          "files_to_create": [],
          "patterns_from": ["apps/backend/review/state.py"],
          "verification": {
            "type": "command",
            "command": "python -c \"from apps.backend.spec.pipeline.orchestrator import SpecOrchestrator; print('OK')\"",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-1-2",
          "description": "Add IPC handlers for spec approval and rejection in main process",
          "service": "backend",
          "files_to_modify": ["apps/frontend/src/main/project-store.ts"],
          "files_to_create": [],
          "patterns_from": ["apps/frontend/src/main/project-store.ts"],
          "verification": {
            "type": "command",
            "command": "grep -q 'approveSpec\\|rejectSpec' apps/frontend/src/main/project-store.ts && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-2-frontend-ui",
      "name": "Frontend Approval UI Components",
      "type": "implementation",
      "description": "Build the spec review modal, approval actions, and visual indicators for tasks awaiting approval",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Create SpecReviewModal component with markdown rendering and approve/reject actions",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": ["apps/frontend/src/renderer/components/task-detail/SpecReviewModal.tsx"],
          "patterns_from": ["apps/frontend/src/renderer/components/ui/dialog.tsx", "apps/frontend/src/renderer/components/task-detail/task-review/DiffViewDialog.tsx"],
          "verification": {
            "type": "command",
            "command": "grep -q 'SpecReviewModal' apps/frontend/src/renderer/components/task-detail/SpecReviewModal.tsx && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-2-2",
          "description": "Add spec approval actions to task-store (openSpecReview, approveSpec, rejectSpec)",
          "service": "frontend",
          "files_to_modify": ["apps/frontend/src/renderer/stores/task-store.ts"],
          "files_to_create": [],
          "patterns_from": ["apps/frontend/src/renderer/stores/task-store.ts"],
          "verification": {
            "type": "command",
            "command": "grep -q 'approveSpec\\|rejectSpec' apps/frontend/src/renderer/stores/task-store.ts && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-2-3",
          "description": "Update TaskActions to show Review Spec button when reviewReason is plan_review",
          "service": "frontend",
          "files_to_modify": ["apps/frontend/src/renderer/components/task-detail/TaskActions.tsx"],
          "files_to_create": [],
          "patterns_from": ["apps/frontend/src/renderer/components/task-detail/TaskActions.tsx"],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000",
            "checks": ["Review Spec button appears for tasks in plan_review state", "No console errors"]
          },
          "status": "pending"
        },
        {
          "id": "subtask-2-4",
          "description": "Add visual indicator badge for tasks awaiting spec approval in task list",
          "service": "frontend",
          "files_to_modify": ["apps/frontend/src/renderer/components/task-detail/TaskHeader.tsx"],
          "files_to_create": [],
          "patterns_from": ["apps/frontend/src/renderer/components/ui/badge.tsx"],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000",
            "checks": ["Badge shows for plan_review tasks", "Badge has distinct styling"]
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-3-ipc-integration",
      "name": "IPC Integration",
      "type": "integration",
      "description": "Wire frontend approval actions to backend IPC handlers and add TypeScript type definitions",
      "depends_on": ["phase-1-backend-state", "phase-2-frontend-ui"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Add approveSpec and rejectSpec to IPC type definitions",
          "service": "frontend",
          "files_to_modify": ["apps/frontend/src/shared/types/ipc.ts"],
          "files_to_create": [],
          "patterns_from": ["apps/frontend/src/shared/types/ipc.ts"],
          "verification": {
            "type": "command",
            "command": "grep -q 'approveSpec\\|rejectSpec' apps/frontend/src/shared/types/ipc.ts && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-3-2",
          "description": "Integrate SpecReviewModal into TaskDetailModal component",
          "service": "frontend",
          "files_to_modify": ["apps/frontend/src/renderer/components/task-detail/TaskDetailModal.tsx"],
          "files_to_create": [],
          "patterns_from": ["apps/frontend/src/renderer/components/task-detail/TaskDetailModal.tsx"],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000",
            "checks": ["Modal opens when Review Spec clicked", "Modal displays spec content", "Approve/Reject buttons functional"]
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-4-end-to-end",
      "name": "End-to-End Verification",
      "type": "integration",
      "description": "Test complete flow from spec creation to approval to implementation start",
      "depends_on": ["phase-3-ipc-integration"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "End-to-end test: Create task with requireReviewBeforeCoding, verify spec approval flow",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Enable 'Require human review before coding' setting",
              "Create a new task",
              "Wait for spec generation to complete",
              "Verify task status is human_review with reviewReason plan_review",
              "Click 'Review Spec' button",
              "Verify spec.md displays in modal",
              "Click 'Approve' button",
              "Verify task transitions to in_progress and implementation starts",
              "Test rejection flow: reject spec and verify task state"
            ]
          },
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 4,
    "total_subtasks": 9,
    "services_involved": ["frontend", "backend"],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": ["phase-1-backend-state", "phase-2-frontend-ui"],
          "reason": "Both have no dependencies and work on different services (backend vs frontend)"
        }
      ],
      "recommended_workers": 2,
      "speedup_estimate": "1.4x faster than sequential - backend and frontend work can happen simultaneously"
    },
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 015 --parallel 2"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": ["unit", "integration", "e2e"],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All existing tests pass",
      "New code has test coverage for approval flow",
      "No regressions in existing task workflow",
      "Spec approval UI is accessible and intuitive",
      "Edge cases handled (missing spec, concurrent approvals)"
    ],
    "verification_steps": [
      {
        "name": "Frontend Unit Tests",
        "command": "cd apps/frontend && npm test",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Frontend Integration Tests",
        "command": "cd apps/frontend && npm run test:integration",
        "expected_outcome": "All integration tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "End-to-End Tests",
        "command": "cd apps/frontend && npx playwright test",
        "expected_outcome": "Approval flow E2E test passes",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Manual Browser Verification",
        "command": "cd apps/frontend && npm run dev",
        "expected_outcome": "Spec approval flow works end-to-end in browser",
        "type": "manual",
        "required": true,
        "blocking": false
      }
    ],
    "reasoning": "Medium risk workflow change requires comprehensive testing. Critical user flow must work correctly to avoid blocking task execution."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": ["cd apps/frontend && npm test"],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": ["cd apps/frontend && npm run test:integration"],
      "services_to_test": ["frontend", "backend"]
    },
    "e2e_tests": {
      "required": true,
      "commands": ["cd apps/frontend && npx playwright test"],
      "flows": ["spec-approval-flow", "spec-rejection-flow"]
    },
    "browser_verification": {
      "required": true,
      "pages": [
        {
          "url": "http://localhost:3000/",
          "checks": ["Review Spec button appears", "Modal opens", "Spec content renders", "Approve/Reject work", "No console errors"]
        }
      ]
    },
    "database_verification": {
      "required": false,
      "checks": []
    }
  },
  "qa_signoff": null,
  "created_at": "2025-12-26T07:14:00.000Z",
  "updated_at": "2025-12-26T07:14:00.000Z"
}
